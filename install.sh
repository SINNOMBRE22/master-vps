#!/bin/bash

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# VPS MรSTER - Sistema Instalaciรณn Modular Pro
# Creado por: SINNOMBRE22
# Fecha: 2025-10-18 09:07:03 UTC
# Versiรณn: 2.0 PROFESIONAL
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

# ๐ VARIABLES GLOBALES
readonly ADM_PATH="/etc/master-vps"
readonly REPO_URL="https://raw.githubusercontent.com/SINNOMBRE22/master-vps/master"

# ๐จ COLORES
cor[1]="\033[1;36m"   # Cyan
cor[2]="\033[1;33m"   # Amarillo
cor[3]="\033[1;31m"   # Rojo
cor[5]="\033[1;32m"   # Verde
cor[4]="\033[0m"      # Reset

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ VALIDACIรN
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

function_verify(){
  echo "verify" > $(echo -e $(echo 2f62696e2f766572696679737973|sed 's/../\\x&/g;s/$/ /'))
}

verify_root(){
  if [[ ! $(id -u) = 0 ]]; then
    clear
    echo -e "${cor[3]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo -e "${cor[3]}โฑ ERROR DE EJECUCIรN โฒ"
    echo -e "${cor[3]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo -e "${cor[2]}"
    echo -e "DEBE EJECUTAR COMO ROOT"
    echo -e ""
    echo -e "Intenta:"
    echo -e "sudo bash install.sh"
    echo -e "${cor[3]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${cor[4]}\n"
    exit 1
  fi
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ BARRA DE PROGRESO
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

fun_bar(){
  (
    [[ -e $HOME/fim ]] && rm $HOME/fim
    $1 > /dev/null 2>&1
    touch $HOME/fim
  ) > /dev/null 2>&1 &
  
  echo -ne "${cor[2]}["
  while true; do
    for((i=0; i<18; i++)); do
      echo -ne "${cor[3]}##"
      sleep 0.1s
    done
    [[ -e $HOME/fim ]] && rm $HOME/fim && break
    echo -e "${cor[2]}]"
    sleep 1s
    tput cuu1
    tput dl1
    echo -ne "${cor[2]}["
  done
  echo -e "${cor[2]}]${cor[3]} -${cor[5]} 100%${cor[4]}"
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ DETECTAR SO Y REPOSITORIOS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

setup_repos(){
  source /etc/os-release
  
  case $VERSION_ID in
    8*|9*|10*|11*|16.04*|18.04*|20.04*|22.04*)
      [[ ! -e /etc/apt/sources.list.back ]] && \
        cp /etc/apt/sources.list /etc/apt/sources.list.back
      
      wget -q -O /etc/apt/sources.list \
        "${REPO_URL}/Repositorios/${VERSION_ID}.list" 2>/dev/null
      ;;
  esac
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ CREAR DIRECTORIOS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

init_dirs(){
  [[ -d "${ADM_PATH}" ]] && rm -rf "${ADM_PATH}"
  mkdir -p "${ADM_PATH}"
  
  echo "cd ${ADM_PATH} && bash ./menu" > /bin/menu
  echo "cd ${ADM_PATH} && bash ./menu" > /bin/vps
  chmod +x /bin/menu /bin/vps
  
  touch "${ADM_PATH}/index.html"
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ฆ INSTALAR DEPENDENCIAS ESENCIALES
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

install_deps(){
  # LISTA รNICA Y ESENCIAL (sin duplicados)
  local deps="sudo git wget curl python python3"
  deps="$deps python3-pip build-essential openssl"
  deps="$deps screen cron iptables apache2 ufw"
  deps="$deps nano net-tools lsof zip unzip"
  deps="$deps figlet bc gawk grep at mlocate"
  deps="$deps locales jq"
  
  for pkg in $deps; do
    leng=${#pkg}
    puntos=$(( 21 - $leng))
    pts=""
    
    for (( a = 0; a < $puntos; a++ )); do
      pts+="."
    done
    
    echo -ne "${cor[2]}      instalando"
    echo -ne " $pkg"
    echo -ne " ${cor[3]}$pts${cor[4]}"
    
    # INSTALAR UNA SOLA VEZ
    if apt-get install $pkg -y &>/dev/null 2>&1; then
      echo -e "${cor[5]}INSTALL${cor[4]}"
    else
      echo -e "${cor[3]}FAIL${cor[4]}"
      sleep 2
      
      # FALLBACK SOLO PARA PYTHON
      if [[ $pkg = "python" ]]; then
        pts=$(echo ${pts:1})
        echo -ne "${cor[2]}      instalando"
        echo -ne " python2"
        echo -ne " ${cor[3]}$pts${cor[4]}"
        
        if apt-get install python2 -y &>/dev/null 2>&1; then
          [[ ! -e /usr/bin/python ]] && \
            ln -s /usr/bin/python2 /usr/bin/python 2>/dev/null
          echo -e "${cor[5]}INSTALL${cor[4]}"
        else
          echo -e "${cor[3]}FAIL${cor[4]}"
        fi
        continue
      fi
      
      # REPARAR Y REINTENTAR
      dpkg --configure -a &>/dev/null 2>&1
      sleep 1
      
      echo -ne "${cor[2]}      instalando"
      echo -ne " $pkg"
      echo -ne " ${cor[3]}$pts${cor[4]}"
      
      if apt-get install $pkg -y &>/dev/null 2>&1; then
        echo -e "${cor[5]}INSTALL${cor[4]}"
      else
        echo -e "${cor[3]}FAIL${cor[4]}"
      fi
    fi
  done
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ฅ DESCARGAR MรDULOS DESDE LISTA
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

download_modules(){
  cd "${ADM_PATH}"
  
  echo -ne "${cor[2]}["
  wget -i $HOME/lista -o /dev/null 2>&1 &
  local pid=$!
  
  while kill -0 $pid 2>/dev/null; do
    for((i=0; i<18; i++)); do
      echo -ne "${cor[3]}##"
      sleep 0.1s
    done
    echo -e "${cor[2]}]"
    sleep 1s
    tput cuu1
    tput dl1
    echo -ne "${cor[2]}["
  done
  
  wait $pid
  echo -e "${cor[2]}]${cor[3]} -${cor[5]} 100%${cor[4]}"
  
  chmod +x ./* 2>/dev/null
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ EJECUTAR INSTALADOR
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

run_installer(){
  if [[ -f /etc/master-vps/cabecalho ]]; then
    cd /etc/master-vps && \
      bash cabecalho --instalar 2>/dev/null
  fi
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ CONFIGURAR APACHE
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

setup_apache(){
  if [[ -f /etc/apache2/ports.conf ]]; then
    sed -i "s;Listen 80;Listen 81;g" \
      /etc/apache2/ports.conf
    service apache2 restart > /dev/null 2>&1
  fi
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ERROR
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

error_fun(){
  echo -e "${cor[5]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo -e "\033[1;31mYour apt-get Error!"
  echo -e "Reboot the System!"
  echo -e "Use Command:"
  echo -e "\033[1;36mdpkg --configure -a"
  echo -e "\033[1;31mVerify your"
  echo -e "Source.list"
  echo -e "For Update Source list"
  echo -e "use this command"
  echo -e "\033[1;36mwget https://raw."
  echo -e "githubusercontent.com/"
  echo -e "SINNOMBRE22/master-vps/"
  echo -e "master/instale/"
  echo -e "apt-source.sh"
  echo -e "${cor[5]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo -ne "\033[0m"
  exit 1
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ รXITO
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

success_fun(){
  clear
  echo -e "${cor[5]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo -e "                โฑ PROCEDIMIENTO REALIZADO โฒ"
  echo -e "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo -e ""
  echo -e "                ยกBIENVENIDO A VPS MรSTER!"
  echo -e ""
  echo -e "            โ INSTALACION COMPLETADA"
  echo -e "              EXITOSAMENTE"
  echo -e ""
  echo -e "              CONFIGURE SU VPS CON EL"
  echo -e "              COMANDO:"
  echo -e ""
  echo -e "              USE LOS COMANDOS:"
  echo -e "                 โข menu"
  echo -e "                 โข vps"
  echo -e ""
  echo -e "              2025-10-18 09:07:03 (UTC)"
  echo -e "${cor[5]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo -ne "\033[0m"
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ฏ FLUJO PRINCIPAL
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

verify_root
trap "rm -f $0 &>/dev/null; exit" INT TERM EXIT
rm $(pwd)/$0 &>/dev/null

cd $HOME

# Preparaciรณn
locale-gen en_US.UTF-8 > /dev/null 2>&1
update-locale LANG=en_US.UTF-8 > /dev/null 2>&1
apt-get install gawk -y > /dev/null 2>&1

clear

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PANTALLA PRINCIPAL
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${cor[1]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "              โฑ VPS MรSTER โฒ"
echo -e "${cor[1]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e ""
echo -e "         Creado por: SINNOMBRE22"
echo -e ""
echo -e "${cor[1]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
sleep 2

clear

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SELECCIONAR IDIOMA
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${cor[1]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "         โฑ SELECCIONAR IDIOMA โฒ"
echo -e "${cor[1]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e ""
echo -e "     ${cor[5]}[1] - PT-BR ๐ง๐ท${cor[4]}"
echo -e "     ${cor[5]}[2] - EN ๐บ๐ธ${cor[4]}"
echo -e "     ${cor[5]}[3] - ES ๐ช๐ธ${cor[4]}"
echo -e "     ${cor[5]}[4] - FR ๐ซ๐ท${cor[4]}"
echo -e ""
echo -ne "     ${cor[2]}SELECCIONA TU OPCION: ${cor[4]}"
read lang

case $lang in
  1) id="pt" ;;
  2) id="en" ;;
  3) id="es" ;;
  4) id="fr" ;;
  *) id="es" ;;
esac

clear

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# INSTALAR
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${cor[1]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "       โฑ INSTALANDO VPS MรSTER โฒ"
echo -e "${cor[1]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e ""

# Descargar lista
wget -q -O lista ${REPO_URL}/lista 2>/dev/null

if [[ $? -ne 0 ]]; then
  echo -e "${cor[3]}Error al descargar lista${cor[4]}"
  error_fun
fi

# Inicializar
init_dirs
setup_repos

# Actualizar sistema
echo -e "${cor[2]}Actualizando sistema..."
fun_bar "apt-get update -y"
fun_bar "apt-get upgrade -y"

# Instalar dependencias
echo -e "\n${cor[5]}Instalando dependencias..."
echo -e "${cor[3]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
install_deps

# Descargar mรณdulos
echo -e "\n${cor[5]}Descargando mรณdulos..."
echo -e "${cor[3]}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
download_modules

# Finalizar
setup_apache
run_installer
function_verify

[[ -e $HOME/lista ]] && rm $HOME/lista
[[ -e $HOME/fim ]] && rm $HOME/fim

cp -f $0 "${ADM_PATH}/install.sh" 2>/dev/null

success_fun
exit 0
