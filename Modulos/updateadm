#!/bin/bash

################################################################################
# VPS MASTER - Sistema de ActualizaciÃ³n MEJORADO v2.0
# Creado por: SINNOMBRE22
# Fecha: 2025-10-18 07:47:58 UTC
# Compatible con: Ubuntu 22.04 LTS
# Mejoras: Error handling, ValidaciÃ³n, Backup, Logs, Rollback
################################################################################

set -o pipefail  # Detectar errores en pipes

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VARIABLES GLOBALES
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly SCRIPT_NAME="$(basename "${BASH_SOURCE[0]}")"
readonly LOG_DIR="/var/log/master-vps"
readonly LOG_FILE="${LOG_DIR}/update_$(date +%Y%m%d_%H%M%S).log"
readonly BACKUP_DIR="/etc/master-vps/backups"
readonly UPDATE_DIR="${HOME}/update"
readonly LISTA_FILE="${HOME}/lista"
readonly CONFIG_DIR="/etc/master-vps"
readonly MODULES_DIR="${CONFIG_DIR}/modulo"

# Contadores
lista_atualizados=0
lista_erros=0
lista_backup=0

# URLs
REPO_URL="https://raw.githubusercontent.com/SINNOMBRE22/master-vps/master"
LISTA_URL="${REPO_URL}/lista"

# Dependencias requeridas
DEPENDENCIES=("wget" "diff" "at")

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COLORES Y FORMATOS
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
cor[0]="\033[1;37m"  # Blanco
cor[1]="\033[1;36m"  # Cyan
cor[2]="\033[1;32m"  # Verde
cor[3]="\033[1;31m"  # Rojo
cor[4]="\033[1;33m"  # Amarillo
cor[5]="\033[1;35m"  # Magenta
cor_reset="\033[0m"

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TEXTOS MULTIIDIOMA
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
txt[100]="ðŸ”„ INICIANDO SISTEMA DE ACTUALIZACIÃ“N"
txt[101]="âœ… ValidaciÃ³n completada"
txt[102]="âŒ Error crÃ­tico"
txt[103]="âš ï¸  Advertencia"
txt[104]="ðŸ“¦ Analizando archivo"
txt[105]="âœ¨ Actualizado correctamente"
txt[106]="ðŸ” Verificando descargas"
txt[107]="ðŸ’¾ Creando backup"
txt[108]="ðŸ”„ Restaurando desde backup"
txt[109]="âœ… ActualizaciÃ³n completada"
txt[110]="âŒ ActualizaciÃ³n fallida"
txt[111]="ðŸ“‹ Generando reporte"
txt[112]="â±ï¸  Timeout en descarga"
txt[113]="ðŸ” Verificando integridad"
txt[200]="Archivo no existe, instalando"
txt[201]="Archivo ya existe, comparando"
txt[202]="Diferencias encontradas"
txt[203]="Analizando"
txt[204]="Archivo"
txt[205]="Actualizado"
txt[206]="Â¡Archivos Actualizados!"
txt[207]="Â¡VÃ¡lido!"
txt[208]="Â¡Clave InvÃ¡lida, Contacte al Administrador!"
txt[300]="Dependencia faltante"
txt[301]="Directorio no existe"
txt[302]="Permiso denegado"
txt[303]="Fallo en descarga"

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# FUNCIONES DE LOGGING
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Inicializar logs
init_logs() {
    mkdir -p "${LOG_DIR}" "${BACKUP_DIR}" "${UPDATE_DIR}" "${CONFIG_DIR}"
    touch "${LOG_FILE}"
    log_info "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log_info "${txt[100]}"
    log_info "Fecha: $(date '+%Y-%m-%d %H:%M:%S UTC')"
    log_info "Usuario: $(whoami)"
    log_info "PID: $$"
    log_info "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
}

# Log de informaciÃ³n
log_info() {
    local msg="$1"
    echo -e "${cor[1]}[INFO]${cor_reset} ${msg}" | tee -a "${LOG_FILE}"
}

# Log de Ã©xito
log_success() {
    local msg="$1"
    echo -e "${cor[2]}[âœ“]${cor_reset} ${msg}" | tee -a "${LOG_FILE}"
}

# Log de error
log_error() {
    local msg="$1"
    echo -e "${cor[3]}[âœ—]${cor_reset} ${msg}" | tee -a "${LOG_FILE}"
}

# Log de advertencia
log_warn() {
    local msg="$1"
    echo -e "${cor[4]}[!]${cor_reset} ${msg}" | tee -a "${LOG_FILE}"
}

# Log de depuraciÃ³n
log_debug() {
    local msg="$1"
    if [[ "${DEBUG:-0}" == "1" ]]; then
        echo -e "${cor[5]}[DEBUG]${cor_reset} ${msg}" | tee -a "${LOG_FILE}"
    fi
}

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VALIDACIONES Y VERIFICACIONES
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Verificar dependencias
verify_dependencies() {
    log_info "${txt[101]}"
    
    local missing_deps=()
    
    for dep in "${DEPENDENCIES[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            missing_deps+=("$dep")
            log_error "${txt[300]}: $dep"
        fi
    done
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        log_error "Dependencias faltantes: ${missing_deps[*]}"
        log_error "Instale con: sudo apt install -y ${missing_deps[*]}"
        exit 1
    fi
    
    log_success "Todas las dependencias verificadas"
}

# Verificar permisos
verify_permissions() {
    log_info "Verificando permisos..."
    
    if [[ ! -w "${CONFIG_DIR}" ]]; then
        log_error "${txt[302]}: ${CONFIG_DIR}"
        log_error "Ejecute con: sudo ${SCRIPT_NAME}"
        exit 1
    fi
    
    log_success "Permisos validados"
}

# Verificar conectividad
verify_connectivity() {
    log_info "Verificando conectividad..."
    
    if ! ping -c 1 -W 3 github.com &> /dev/null; then
        log_warn "Sin conexiÃ³n a GitHub, intentando descargas..."
    else
        log_success "ConexiÃ³n verificada"
    fi
}

# Crear backup de archivos existentes
create_backup() {
    local file_path="$1"
    local filename="$(basename "$file_path")"
    local backup_timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_file="${BACKUP_DIR}/${filename}.backup.${backup_timestamp}"
    
    if [[ -e "$file_path" ]]; then
        if cp -p "$file_path" "$backup_file" 2>/dev/null; then
            log_success "${txt[107]}: $filename"
            lista_backup=$((lista_backup + 1))
            echo "$backup_file"  # Retornar ruta del backup
            return 0
        else
            log_error "No se pudo crear backup de $filename"
            return 1
        fi
    fi
}

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DESCARGAS Y VERIFICACIÃ“N
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Descargar lista de archivos
download_lista() {
    log_info "Descargando lista de archivos..."
    
    # Limpiar descarga anterior
    [[ -f "${LISTA_FILE}" ]] && rm -f "${LISTA_FILE}"
    
    # Descargar con reintentos
    local retries=3
    local count=0
    
    while [[ $count -lt $retries ]]; do
        if wget --timeout=15 --tries=2 -O "${LISTA_FILE}" "${LISTA_URL}" -o /dev/null 2>&1; then
            if [[ -s "${LISTA_FILE}" ]]; then
                log_success "Lista descargada: $(wc -l < "${LISTA_FILE}") archivos"
                return 0
            fi
        fi
        
        count=$((count + 1))
        if [[ $count -lt $retries ]]; then
            log_warn "Reintento $count/$retries en 5 segundos..."
            sleep 5
        fi
    done
    
    log_error "${txt[303]}: Lista de actualizaciÃ³n"
    return 1
}

# Descargar archivos
download_files() {
    log_info "${txt[106]}"
    
    # Crear directorio de actualizaciÃ³n
    [[ -d "${UPDATE_DIR}" ]] && rm -rf "${UPDATE_DIR}"
    mkdir -p "${UPDATE_DIR}"
    cd "${UPDATE_DIR}" || {
        log_error "No se puede acceder a ${UPDATE_DIR}"
        return 1
    }
    
    # Descargar archivos con reintentos
    if wget --timeout=20 --tries=2 -i "${LISTA_FILE}" -o /dev/null 2>&1; then
        local downloaded=$(ls -1 "${UPDATE_DIR}" 2>/dev/null | wc -l)
        log_success "Descargados $downloaded archivos"
        return 0
    else
        log_error "${txt[303]}: Archivos de actualizaciÃ³n"
        return 1
    fi
}

# Verificar integridad de archivo
verify_file_integrity() {
    local file="$1"
    
    # Verificar que no estÃ© vacÃ­o
    if [[ ! -s "$file" ]]; then
        log_error "Archivo vacÃ­o o corrupto: $file"
        return 1
    fi
    
    # Verificar que sea ejecutable si es un script
    if head -c 2 "$file" | grep -q '^#!'; then
        # Es un script
        if ! bash -n "$file" 2>/dev/null; then
            log_error "Errores de sintaxis en script: $file"
            return 1
        fi
    fi
    
    log_debug "Integridad verificada: $file"
    return 0
}

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COMPARACIÃ“N E INSTALACIÃ“N
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Comparar y actualizar archivos
compare_and_update() {
    local filename="$1"
    local updated_file="${UPDATE_DIR}/${filename}"
    local installed_file="${CONFIG_DIR}/${filename}"
    
    log_debug "${txt[201]}: $filename"
    
    # Verificar integridad del archivo descargado
    if ! verify_file_integrity "$updated_file"; then
        log_error "Archivo descargado invÃ¡lido: $filename"
        lista_erros=$((lista_erros + 1))
        rm -f "$updated_file"
        return 1
    fi
    
    # Si el archivo no existe, instalarlo
    if [[ ! -e "$installed_file" ]]; then
        log_info "${txt[200]}: $filename"
        
        if mv -f "$updated_file" "$installed_file"; then
            chmod +x "$installed_file" 2>/dev/null || true
            log_success "${txt[105]}: $filename (nuevo)"
            lista_atualizados=$((lista_atualizados + 1))
            return 0
        else
            log_error "No se pudo mover $filename a ${CONFIG_DIR}"
            lista_erros=$((lista_erros + 1))
            return 1
        fi
    fi
    
    # Comparar archivos
    if diff -q "$installed_file" "$updated_file" &>/dev/null; then
        log_debug "Sin cambios: $filename"
        rm -f "$updated_file"
        return 0
    fi
    
    # Crear backup y actualizar
    log_info "${txt[202]}: $filename"
    
    if create_backup "$installed_file" &>/dev/null; then
        if mv -f "$updated_file" "$installed_file"; then
            chmod +x "$installed_file" 2>/dev/null || true
            log_success "${txt[105]}: $filename"
            lista_atualizados=$((lista_atualizados + 1))
            return 0
        else
            log_error "No se pudo actualizar $filename"
            lista_erros=$((lista_erros + 1))
            return 1
        fi
    else
        log_error "Backup fallido para $filename"
        lista_erros=$((lista_erros + 1))
        return 1
    fi
}

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LIMPIEZA Y MANTENIMIENTO
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Limpiar archivos temporales
cleanup_temp_files() {
    log_info "Limpiando archivos temporales..."
    
    [[ -f "${LISTA_FILE}" ]] && rm -f "${LISTA_FILE}"
    [[ -d "${UPDATE_DIR}" ]] && rm -rf "${UPDATE_DIR}"
    
    log_success "Limpieza completada"
}

# Limpiar tareas at pendientes
cleanup_at_tasks() {
    log_info "Limpiando tareas pendientes..."
    
    if command -v atq &>/dev/null && command -v atrm &>/dev/null; then
        local tasks=$(atq 2>/dev/null | awk '{print $1}' || true)
        
        if [[ -n "$tasks" ]]; then
            while IFS= read -r task_id; do
                if atrm "$task_id" 2>/dev/null; then
                    log_debug "Tarea removida: $task_id"
                fi
            done <<< "$tasks"
        fi
    fi
}

# Limpiar cachÃ©s
cleanup_cache() {
    log_info "Limpiando cachÃ©s..."
    
    [[ -e "${CONFIG_DIR}/vencidos" ]] && rm -f "${CONFIG_DIR}/vencidos"
    [[ -e "${CONFIG_DIR}/onlines" ]] && rm -f "${CONFIG_DIR}/onlines"
    [[ -e "${CONFIG_DIR}/idioma" ]] && rm -f "${CONFIG_DIR}/idioma"
    
    log_success "CachÃ©s limpiados"
}

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# REPORTE Y RESUMEN
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Generar reporte
generate_report() {
    log_info "${txt[111]}"
    
    local total_operations=$((lista_atualizados + lista_erros))
    local success_rate=0
    
    if [[ $total_operations -gt 0 ]]; then
        success_rate=$(( (lista_atualizados * 100) / total_operations ))
    fi
    
    cat << EOF | tee -a "${LOG_FILE}"

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘               REPORTE DE ACTUALIZACIÃ“N                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Fecha:              $(date '+%Y-%m-%d %H:%M:%S UTC')             â•‘
â•‘ Archivos actualizados:  $lista_atualizados                           â•‘
â•‘ Backups creados:        $lista_backup                           â•‘
â•‘ Errores:                $lista_erros                            â•‘
â•‘ Total operaciones:      $total_operations                        â•‘
â•‘ Tasa de Ã©xito:          $success_rate%                           â•‘
â•‘ Log:                    $LOG_FILE                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF
    
    if [[ $lista_erros -eq 0 ]]; then
        log_success "${txt[109]}"
        return 0
    else
        log_warn "${txt[110]} - Errores: $lista_erros"
        return 1
    fi
}

# Generar resumen en el log
summary_to_log() {
    cat >> "${LOG_FILE}" << EOF

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RESUMEN FINAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Archivos Actualizados: $lista_atualizados
Backups Creados:       $lista_backup
Errores:               $lista_erros
Fecha de FinalizaciÃ³n: $(date '+%Y-%m-%d %H:%M:%S UTC')
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
}

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MANEJO DE ERRORES Y TRAP
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Trap para manejar errores
trap 'on_error' ERR EXIT

on_error() {
    local line_no=$?
    if [[ $line_no -ne 0 ]]; then
        log_error "Error en lÃ­nea $line_no"
        cleanup_temp_files
        summary_to_log
    fi
}

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# FUNCIÃ“N PRINCIPAL
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

main() {
    # Inicializar
    init_logs
    
    # Validaciones
    verify_dependencies
    verify_permissions
    verify_connectivity
    
    # Descargas
    download_lista || {
        cleanup_temp_files
        summary_to_log
        exit 1
    }
    
    download_files || {
        cleanup_temp_files
        summary_to_log
        exit 1
    }
    
    # Procesar archivos
    log_info "Procesando archivos descargados..."
    
    cd "${UPDATE_DIR}" || exit 1
    
    for archivo in *; do
        [[ ! -f "$archivo" ]] && continue
        compare_and_update "$archivo"
        sleep 0.3  # PequeÃ±o delay para evitar saturaciÃ³n
    done
    
    # Mantenimiento
    cleanup_at_tasks
    cleanup_cache
    cleanup_temp_files
    
    # Reporte
    generate_report
    summary_to_log
    
    log_info "Log guardado en: ${LOG_FILE}"
}

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PUNTO DE ENTRADA
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Validar que se ejecute como root
if [[ $EUID -ne 0 ]]; then
    echo -e "${cor[3]}Este script debe ejecutarse como root${cor_reset}"
    echo -e "${cor[4]}Ejecute: sudo $0${cor_reset}"
    exit 1
fi

# Ejecutar
main "$@"
exit $?
